{% extends 'base.html' %}
{% block title %}{% if card_type %}{{ card_type.name }}{% else %}New Card Type{% endif %} | Card Types{% endblock %}
{% block content %}
<div class="mx-auto max-w-4xl space-y-6">
    <header class="flex flex-col gap-2">
        <h1 class="text-2xl font-semibold">{% if card_type %}{{ card_type.name }}{% else %}New Card Type{% endif %}</h1>
        <p class="text-sm text-gray-500">Define how cards render and how Markdown imports map into this template.</p>
    </header>

    <form method="post" class="space-y-6">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="rounded border border-red-200 bg-red-50 p-3 text-sm text-red-700 space-y-1">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        {% if formset.non_form_errors %}
            <div class="rounded border border-red-200 bg-red-50 p-3 text-sm text-red-700 space-y-1">
                {% for error in formset.non_form_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        <fieldset class="space-y-4" {% if not can_edit %}disabled{% endif %}>
            <section class="rounded border bg-white p-5 shadow space-y-4">
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        {{ form.name.label_tag }}
                        {{ form.name }}
                        {% for error in form.name.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div>
                        {{ form.slug.label_tag }}
                        {{ form.slug }}
                        {% for error in form.slug.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    {{ form.description.label_tag }}
                    {{ form.description }}
                    {% for error in form.description.errors %}
                        <p class="text-xs text-red-600">{{ error }}</p>
                    {% endfor %}
                </div>
                <div>
                    {{ form.field_schema.label_tag }}
                    {{ form.field_schema }}
                    <p class="text-xs text-gray-500">{{ form.field_schema.help_text }}</p>
                    {% for error in form.field_schema.errors %}
                        <p class="text-xs text-red-600">{{ error }}</p>
                    {% endfor %}
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        {{ form.front_template.label_tag }}
                        {{ form.front_template }}
                        {% for error in form.front_template.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div>
                        {{ form.back_template.label_tag }}
                        {{ form.back_template }}
                        {% for error in form.back_template.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <section class="rounded border bg-white p-5 shadow space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-700">Import formats</h2>
                </div>
                <p class="text-sm text-gray-500">Each format describes how Markdown imports should detect this card type.</p>
                {{ formset.management_form }}
                <div class="space-y-4">
                    {% for form in formset.forms %}
                        <div class="rounded border border-gray-200 p-4 space-y-3">
                            <div class="grid gap-3 md:grid-cols-2">
                                <div>
                                    {{ form.name.label_tag }}
                                    {{ form.name }}
                                    {% for error in form.name.errors %}
                                        <p class="text-xs text-red-600">{{ error }}</p>
                                    {% endfor %}
                                </div>
                                <div>
                                    {{ form.format_kind.label_tag }}
                                    {{ form.format_kind }}
                                    {% for error in form.format_kind.errors %}
                                        <p class="text-xs text-red-600">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div>
                                {{ form.template.label_tag }}
                                {{ form.template }}
                                {% for error in form.template.errors %}
                                    <p class="text-xs text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                            <div>
                                {{ form.options.label_tag }}
                                {{ form.options }}
                                {% for error in form.options.errors %}
                                    <p class="text-xs text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                            {% if can_edit %}
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    {{ form.DELETE }} <label>Delete format</label>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </section>
        </fieldset>

        {% if can_edit %}
            <div class="flex justify-end gap-3">
                <a href="{% url 'card_types:list' %}" class="rounded border border-gray-300 px-4 py-2 text-sm text-gray-600 hover:bg-gray-50">Cancel</a>
                <button type="submit" class="rounded bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700">Save changes</button>
            </div>
        {% else %}
            <div class="flex justify-between rounded border border-indigo-100 bg-indigo-50 px-4 py-2 text-sm text-indigo-700">
                <span>This card type is read-only.</span>
                <a href="{% url 'card_types:create' %}?source={{ card_type.id }}" class="underline">Duplicate to edit</a>
            </div>
        {% endif %}
    </form>
</div>
{% endblock %}
